# 项目报告：聊天系统与新闻模块集成平台

本文档面向评审与维护人员，完整说明本项目的数据源、选用技术与作品初步设计。报告基于代码实际实现撰写，引用的路径均以 `mychat/` 为根。

## 分组情况
null

## 数据源

本项目的数据面向两大域：即时聊天与新闻内容。

### 1) 数据库与表结构（MySQL）

- 配置文件：`db/config.json`，键 `mysql` 指定连接、字符集与时区。
- 连接封装：`server/mysql.js` 使用 `mysql2/promise` 建立连接池。
- 主要表定义：`db/news_schema.sql`
	- `users`：系统用户。字段：id, username, password_hash, role('user'|'admin'), avatar_url, email, created_at, updated_at。
	- `news_categories`：新闻分类。字段：id, name, description, created_at, updated_at。
	- `news`：新闻主表。字段：id, title, slug(唯一), summary, content(longtext), author_id -> users.id, category_id -> news_categories.id, status('draft'|'published'|'archived'), cover_image, published_at, created_at, updated_at。
	- `news_attachments`：附件表。字段：id, news_id -> news.id, filename, file_path, file_type, file_size, uploaded_at。
	- `comments`：评论表。字段：id, news_id -> news.id, user_id -> users.id, content, is_deleted, created_at, updated_at。
	- `news_metrics`：指标表。以 news_id 为主键，记录 view_count/comment_count/like_count/score，便于排序与热度计算。
	- `news_audit_log`：审计日志。记录管理员对新闻域的操作（备份、恢复、CRUD 等）。

关系概要：

- users 1..n news（作者）
- news_categories 1..n news（分类）
- news 1..n news_attachments
- news 1..n comments；users 1..n comments（评论用户）
- news 1..1 news_metrics

### 2) 即时聊天存储（NeDB 文件型）

- 定义：`server/db.js`
- 文件：`db/users.db`、`db/messages.db`
- 使用位置：`server/store.js`
	- `saveUser`/`getUsers` 用于登录记录
	- `saveMessage`/`getMessages` 用于群聊消息（支持文本、图片、文件占位路径）

聊天域与新闻域相互独立：聊天走 NeDB（轻量离线文件库），新闻域走 MySQL（结构化数据）。

### 3) Redis 缓存与限流

- 配置：`db/config.json` -> `redis`（含 keyPrefix，默认 `mychat:news:`）。
- 客户端封装：`server/redis.js`（使用 ioredis）。
- 使用的键：
	- `news:{id}`：新闻详情缓存（5 分钟），来源 `services/newsService.getNewsById`
	- `recent:list`：最新新闻列表缓存（列表结构）
	- `hot:zset`：热门新闻有序集合（score 由指标/行为驱动）
	- `metrics:views`：浏览量临时哈希，叠加视图数
	- `rate:{ip}`：基于 IP 的请求计数（`server/middleware/rateLimit.js`），时间窗与阈值来自 `config.news.rateLimit`

### 4) 文件存储

- 上传目录：`upload/files/`，静态映射：
	- 服务端挂载：`server/index.js`
	- 访问前缀：`/assets/files/*`
- 中间件：`multer`（`server/index.js`），限制大小、扩展名与 MIME（配置来自 `db/config.json.upload`）。
- 返回体：`{ filePath, filename, size }`，用于新闻封面与附件。

历史图片（聊天域）存储于 `upload/`，由 `store.js` 写入，映射为 `/assets/images/*`（保留兼容）。

### 5) 数据流（端到端）

- 新闻列表/详情：Vue 组件 `src/components/news/NewsCenter.vue` 通过 `src/services/newsApi.js` 调用 REST：
	- 列表：`GET /api/news`（分页与筛选）
	- 详情：`GET /api/news/:id`
	- 热门/最新：`GET /api/news/hot`、`GET /api/news/recent`
	- 评论：`GET/POST/DELETE /api/news/:id/comments`
	- 分类：`GET/POST/PUT/DELETE /api/news/categories`
	- 指标：`POST /api/news/:id/views`
	- 管理能力（需 admin）：审计 `GET /api/news/audit/logs`、统计 `GET /api/news/stats`、备份/恢复/清空/生成测试数据：
		- `GET|POST /api/news/admin/backup`、`POST /api/news/admin/restore`
		- `POST /api/news/admin/reset`（仅 root）
		- `POST /api/news/admin/seed`（仅 root）
- 聊天：`server/io.js` 使用 Socket.IO，客户端在 `ChatApp.vue` 中初始化连接与事件处理，消息回落存储见 `server/store.js`。

## 选用的技术

### 前端

- 框架：Vue 2.x（`^2.6.11`），CLI Service 4.x
- 主要组件：`ChatApp.vue`（主壳）、`news/NewsCenter.vue`（新闻中心，含管理后台视图）
- 构建脚本：`mychat/package.json` -> `npm run start` 同时启后端与前端；`serve`、`build`、`prod` 脚本分别用于开发、打包与仅启动后端

### 后端

- 运行时/框架：Node.js + Express（`server/index.js`）
- 实时通信：Socket.IO（聊天域 `server/io.js`）
- ORM/驱动：`mysql2/promise`（MySQL）、`ioredis`（Redis）
- 轻量数据：NeDB（聊天日志）
- 上传：multer（限制文件类型/大小）
- 认证与权限：
	- JWT：`server/jwt.js`（对称密钥，1 天过期）
	- 中间件：`server/middleware/auth.js`（`optionalAuth`、`requireAuth`、`requireAdmin`）；首次携带用户名登录时自动在 `users` 持久化，用户名为 `root` 则标记为 admin
	- 频率限制：`server/middleware/rateLimit.js`（基于 Redis 的 IP 计数）

### 安全与鲁棒

- 文件白名单与大小限制防止危险上传
- SQL 使用参数化，避免注入
- 管理接口需 `admin`；破坏性操作（reset/seed）再限制为 `root`
- 备份/恢复采用事务 + 外键关闭/恢复，失败分支确保回滚并恢复 FK 设置；恢复后清空缓存

## 作品初步设计

### 1) 总体架构

- 前端单页（Vue）+ 后端 REST & WebSocket（Express + Socket.IO）
- 数据分层：
	- 聊天域：NeDB 文件存储，快速易用
	- 新闻域：MySQL 结构化 + Redis 缓存（热点/最近/视图累积）
- 静态与上传资源通过 Express 静态目录服务

### 2) 模块划分

- 前端：
	- `components/ChatApp.vue`：应用外壳与菜单；root 用户注入“管理后台”入口
	- `components/news/NewsCenter.vue`：新闻列表/详情/评论、编辑器与“管理后台”（文章管理分页、分类管理、操作日志、热力图统计、备份/恢复/生成/清空）
	- `services/newsApi.js`：REST 调用封装
- 后端：
	- `routes/newsRouter.js`：REST 路由
	- `services/newsService.js`：领域业务（CRUD、评论、指标、统计、审计、备份/恢复/清空/生成）
	- `middleware/*`：认证、限流、异步错误捕获
	- `index.js`：Express 初始化、上传端点与静态资源
	- `io.js`：Socket.IO 聊天通道

### 3) 主要业务流程

- 新闻浏览：列表 -> 详情 -> 浏览量自增；评论分页加载与删除权限（作者或管理员）
- 新闻编辑：登录用户可发文；作者或管理员可编辑/删除；附件通过 `/upload/file` 上传后回填路径
- 管理后台：
	- 文章管理：分页（每页 5 条），编辑/删除；与前台共用查询接口（后台切换时强制 `pageSize=5`）
	- 分类管理：就地编辑名称/描述、保存/删除
	- 统计：分类与作者热力图（按发布量着色；无数据时空态）
	- 审计日志：展示最近操作轨迹
	- 备份/恢复：
		- 备份：快照写入 `server/backups/news-backup.json`（含 meta 与各表数据）；
		- 恢复：事务清空并按备份批量写回，恢复后重置缓存；写回 meta 的 lastRestore*
	- 测试数据：
		- 清空（root）：删除新闻域所有表、清除缓存并移除备份文件
		- 生成（root）：先清空，再批量生成 tester_* 用户、分类、新闻、评论与指标（数量可在服务端默认值处调节）

### 4) 接口清单（节选）

- 公共：
	- `GET /api/news` 列表（分页、分类、关键字、时间段、排序）
	- `GET /api/news/:id` 详情（含附件）
	- `GET /api/news/hot` 热门；`GET /api/news/recent` 最新
	- `POST /api/news/:id/views` 增加浏览
	- `GET /api/news/:id/comments`、`POST /api/news/:id/comments`、`DELETE /api/news/:id/comments/:commentId`
	- `GET /api/news/categories`
- 需认证：
	- `POST /api/news`、`PUT /api/news/:id`、`DELETE /api/news/:id`
- 管理（admin/root）：
	- `GET /api/news/audit/logs`、`GET /api/news/stats`
	- `GET|POST /api/news/admin/backup`、`POST /api/news/admin/restore`
	- `POST /api/news/admin/reset`（仅 root）、`POST /api/news/admin/seed`（仅 root）
	- 上传：`POST /upload/file`（multer 处理）

### 5) 权限模型

- 访客：可浏览新闻列表/详情与公开统计（部分接口需要登录）
- 登录用户：可发布与评论；仅能编辑/删除自己的文章与评论
- 管理员（`role=admin`）：具备分类管理、审计、统计、备份/恢复权限
- 超级管理员（root 用户名）：在管理员权限基础上，增加“清空/生成测试数据”能力

### 6) UI 与交互

- 主壳 `ChatApp.vue` 左侧纵向菜单；root 登录时自动插入“管理后台”菜单
- 新闻中心：
	- 列表卡片视图；侧栏包含热门/最新与筛选器
	- 详情页：正文、附件、评论分页；作者/管理员有编辑/删除操作
	- 管理后台：
		- 文章管理分页（5/页）与表格操作区
		- 分类管理内联输入，保存/删除按钮
		- 统计热力图：栅格布局、按值深浅着色
		- 备份/恢复/生成/清空：顶部工具区按钮，提供进度与空态提示

### 7) 性能与扩展点

- Redis 缓存热点数据，减少数据库压力；热门新闻使用有序集合，最近新闻使用列表
- 指标表预聚合用于排序；浏览量等增量通过 Redis 辅助
- 上传与静态资源分离，便于 CDN 与限流
- 代码层已抽象服务与路由，便于继续扩展如标签、全文检索、草稿箱、定时发布等

### 8) 运行与部署（摘要）

开发：

```bash
cd mychat
npm install
npm run start
```

默认端口：后端 `3000`（`server/index.js`），前端由 Vue CLI Dev Server 提供代理/静态服务（如有配置）。

生产：

```bash
cd mychat
npm run build
node server/index.js
```

确保事先配置好 MySQL 与 Redis（参见 `db/config.json`）。

